---
title: 'Bike Crash 2: The causes of major injuries'
author: "Sighvatur Davidsson"
date: '2022-02-17'
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index.en_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index.en_files/plotly-binding/plotly.js"></script>
<script src="{{< blogdown/postref >}}index.en_files/typedarray/typedarray.min.js"></script>
<script src="{{< blogdown/postref >}}index.en_files/jquery/jquery.min.js"></script>
<link href="{{< blogdown/postref >}}index.en_files/crosstalk/css/crosstalk.min.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index.en_files/crosstalk/js/crosstalk.min.js"></script>
<link href="{{< blogdown/postref >}}index.en_files/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index.en_files/plotly-main/plotly-latest.min.js"></script>
<link href="{{< blogdown/postref >}}index.en_files/tabwid/tabwid.css" rel="stylesheet" />


<div id="outline-for-this-post" class="section level3">
<h3>Outline for this post</h3>
<p>In this post I will be using machine learning methods to extrude insights that can be gained from the <em>bike crash</em>-dataset, that I introduced in my <a href="https://sdavidsson.netlify.app/post/2022-01-24-introducing-the-bike-crash-data/">previous post</a>. In the previous post we looked at the information that has been made available in the dataset, and we concluded that we are working with a dataset that is highly qualitative in nature, hence we must choose appropriate machine learning methods. This is the second part in the series:</p>
<ol style="list-style-type: decimal">
<li><a href="https://sdavidsson.netlify.app/post/2022-01-24-introducing-the-bike-crash-data/">Introducing the bike crash-dataset</a></li>
<li>The causes of major injuries</li>
<li><a href="https://sdavidsson.netlify.app/post/2022-02-17-bike-crash-3-gis-tools-using-the-r-command-line/">GIS-tools using the R-command line</a></li>
</ol>
</div>
<div id="the-business-problem" class="section level3">
<h3>The business problem</h3>
<p>Data analytics is essentially useless if we don’t pay close attention to the core business problem we are working on. After all the purpose of machine learning is to gain insights that can be presented to decision makers in order for them to base their decisions on actual data - as opposed to guesswork or general assumptions. Of course this project does not have an actual decision maker on the receiving end, but as this is a critical consideration in data analytics, I don’t want to leave it out.</p>
<div id="vision-zero" class="section level4">
<h4>Vision zero</h4>
<p>In 2015 the North Carolinian transport authorities adopted a new policy for designing the states transportation network. The adoption of this policy legally obliges the authorities to base their traffic improvement measures on the principles of the Vision Zero project. This project strives to reduce the number of traffic related immobilities or deaths to zero.</p>
<p>The principles are derived from a set of ethical imperatives:
- Citizens lives or mobility can never be traded for other societal advantages
- When citizens lives or mobility are affected preventive measures must be taken</p>
<p>Tingvall &amp; Haworth <a href="https://www.monash.edu/muarc/archive/our-publications/papers/visionzero">(1999)</a> describe this as a paradigm shift in traffic planning.</p>
</div>
<div id="thus-the-question-we-are-trying-to-answer-is" class="section level4">
<h4>Thus the question we are trying to answer is:</h4>
</div>
<div id="can-we-identify-risk-factors-that-increase-the-severity-of-accidents" class="section level4">
<h4><em>Can we identify risk factors that increase the severity of accidents?</em></h4>
<p>Using this knowledge we would be able to allocate ressources to improving the conditions that have the biggest effect on the seriousness of accidents.</p>
<pre class="r"><code># Load packages
pacman::p_load(tidyverse,                      # essential tools
               sf, tmap,                       # mapping tools
               plotly,                         # interactive plotting
               hrbrthemes,                     # cool plotting theme
               tidymodels, baguette, themis,   # modeling tools
               flextable                       # for creating beautiful tables
)
               
# Set standard plotting theme
theme_set(theme_ipsum_ps())

# Read in datasets
bike_crash &lt;- read_rds(&quot;~/R/Projects/bike_crash/processed_data/bike_crash.rds&quot;)</code></pre>
</div>
<div id="outcome-variable" class="section level4">
<h4>Outcome variable</h4>
<p>We will we using the variable <em>crash_sevr</em> as our outcome variable.</p>
<pre class="r"><code># Before selecting I like to save the unedited dataset to memory
bike_crash0 &lt;- bike_crash

# Initial plotting of our outcome variable
(
  bike_crash %&gt;%
  count(crash_sevr) %&gt;% 
  ggplot(aes(x = crash_sevr, y = n, fill = crash_sevr, text = paste0(crash_sevr,&quot;: &quot;, n))) +
  geom_col(fill = &quot;grey60&quot;) +
  ggtitle(&quot;Severity of crashes (2007 - 2019)&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;) +
  theme(axis.text.x=element_text(angle = 30, hjust = 1))
 ) %&gt;% 
  ggplotly(tooltip = c(&quot;text&quot;)) %&gt;% 
  config(displayModeBar = F)</code></pre>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"data":[{"orientation":"v","width":[0.9,0.9,0.9,0.9,0.9,0.9],"base":[0,0,0,0,0,0],"x":[1,2,3,4,5,6],"y":[1396,4716,5057,650,278,76],"text":["No Injury: 1396","Possible Injury: 4716","Suspected Minor Injury: 5057","Suspected Serious Injury: 650","Killed: 278","NA: 76"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(153,153,153,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":95.7011207970112,"r":39.8505603985056,"b":71.5649647156497,"l":67.5799086757991},"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":15.2760481527605},"title":{"text":"Severity of crashes (2007 - 2019)","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans-Bold","size":23.9103362391034},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.4,6.6],"tickmode":"array","ticktext":["No Injury","Possible Injury","Suspected Minor Injury","Suspected Serious Injury","Killed"],"tickvals":[1,2,3,4,5],"categoryorder":"array","categoryarray":["No Injury","Possible Injury","Suspected Minor Injury","Suspected Serious Injury","Killed"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-30,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"y","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-252.85,5309.85],"tickmode":"array","ticktext":["0","1000","2000","3000","4000","5000"],"tickvals":[2.8421709430404e-14,1000,2000,3000,4000,5000],"categoryorder":"array","categoryarray":["0","1000","2000","3000","4000","5000"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"x","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":12.2208385222084}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"source":"A","attrs":{"8b95a544c5b":{"x":{},"y":{},"fill":{},"text":{},"type":"bar"}},"cur_data":"8b95a544c5b","visdat":{"8b95a544c5b":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>Here we see the frequency distribution of the variable categories.</p>
<p>As I demonstrated in <a href="https://sdavidsson.netlify.app/post/2022-01-24-introducing-the-bike-crash-data/">part 1</a> this is very much a qualitative dataset. An obvious choice of machine learning methods is therefore to go with the classification type models. This calls for a recoding of our variable to a dichotomous outcome.</p>
<pre class="r"><code># Outcome variable should be binary with &quot;positive&quot; outcome marked as 1.

# # # # RECODING # # # # # 
# 
#   We&#39;re predicting crash severeness, so the encoding will be:
#     1: Serious injury or killed
#     0: Minor injuries
bike_crash &lt;- bike_crash %&gt;% 

  # First we filter out NA&#39;s
  filter(!is.na(crash_sevr)) %&gt;% 
  mutate( 
    # Then we use an if_else statement to gather the two most serious categories into &#39;Major Injuries&#39; and the rest to &#39;Minor Injuries&#39;
    crash_sevr = if_else(crash_sevr %in% c(&quot;Killed&quot;, &quot;Suspected Serious Injury&quot;), &quot;Major Injuries&quot;, &quot;Minor Injuries&quot;),
   
    # Finally; most classification models require outcome variable to be coded as factor
    crash_sevr = factor(crash_sevr, levels = c(&quot;Major Injuries&quot;, &quot;Minor Injuries&quot;)))

#  Double check recoded variable
contrasts(bike_crash$crash_sevr)</code></pre>
<pre><code>##                Minor Injuries
## Major Injuries              0
## Minor Injuries              1</code></pre>
<pre class="r"><code># Plotting of outcome variable after recoding
(
  bike_crash %&gt;%
  count(crash_sevr) %&gt;%
  mutate(crash_sevr = fct_rev(crash_sevr)) %&gt;% 
  ggplot(aes(x = crash_sevr, y = n, fill = crash_sevr, text = paste0(crash_sevr,&quot;: &quot;, n))) +
  geom_col(fill = &quot;grey60&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;) +
  theme(axis.text.x=element_text(angle = 30, hjust = 1)) 
 ) %&gt;% 
  ggplotly(tooltip = c(&quot;text&quot;)) %&gt;% 
  config(displayModeBar = F)</code></pre>
<div id="htmlwidget-2" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"data":[{"orientation":"v","width":[0.9,0.9],"base":[0,0],"x":[2,1],"y":[928,11169],"text":["Major Injuries: 928","Minor Injuries: 11169"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(153,153,153,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":71.7907845579079,"r":39.8505603985056,"b":71.5649647156497,"l":67.5799086757991},"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":15.2760481527605},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.4,2.6],"tickmode":"array","ticktext":["Minor Injuries","Major Injuries"],"tickvals":[1,2],"categoryorder":"array","categoryarray":["Minor Injuries","Major Injuries"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-30,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"y","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-558.45,11727.45],"tickmode":"array","ticktext":["0","3000","6000","9000"],"tickvals":[0,3000,6000,9000],"categoryorder":"array","categoryarray":["0","3000","6000","9000"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"x","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":12.2208385222084}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"source":"A","attrs":{"8b95447c99b6":{"x":{},"y":{},"fill":{},"text":{},"type":"bar"}},"cur_data":"8b95447c99b6","visdat":{"8b95447c99b6":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>Here’s an updated frequency distribution of our recoded outcome variable. It is very important to notice that we have class imbalance - ie. more than 90 % of the observations are minor injuries. Remember; our objective is to prevent the major injuries by identifying their contributing causes. Left untouched this distribution will almost certainly harm our ability to create a model that can correctly predict the most severe cases. This will be dealt with in the modelling section.</p>
</div>
<div id="predictor-variables" class="section level4">
<h4>Predictor variables</h4>
<p>In my modeling for this post I will be focusing on environmental variables - ie. factors in the physical environment that can be improved.</p>
<pre class="r"><code># Predictor variables
bike_crash &lt;- bike_crash %&gt;% 
    select(
      # Outcome variable
      crash_sevr, 
      # Environmental variables
      starts_with(&quot;rd_&quot;), light_cond, locality, num_lanes, 
      rural_urban, traff_cntrl, speed_limit, workzone, crash_loc, developmen
      ) 

# Option: Omit all NA
# bike_crash &lt;- na.omit(bike_crash)
# Det gør vi ikke, da vi får en bedre model (på alle parametre), hvis vi lader være

colnames(bike_crash)</code></pre>
<pre><code>##  [1] &quot;crash_sevr&quot;  &quot;rd_bent&quot;     &quot;rd_hill&quot;     &quot;rd_class&quot;    &quot;rd_conditio&quot;
##  [6] &quot;rd_config&quot;   &quot;rd_defects&quot;  &quot;rd_feature&quot;  &quot;rd_surface&quot;  &quot;light_cond&quot; 
## [11] &quot;locality&quot;    &quot;num_lanes&quot;   &quot;rural_urban&quot; &quot;traff_cntrl&quot; &quot;speed_limit&quot;
## [16] &quot;workzone&quot;    &quot;crash_loc&quot;   &quot;developmen&quot;</code></pre>
</div>
</div>
<div id="modelling" class="section level3">
<h3>Modelling</h3>
<p>We are now in place to begin our modelling. I will be using testing two different methods against each other; logistic regression and a random forest with bagging.</p>
<pre class="r"><code># I will be modelling using the tidymodels package
# This package was loaded in a previous chunk

# Tidymodels offer control over which model engine to select. 

# Logistic regression
logreg &lt;- logistic_reg() %&gt;% 
  set_engine(engine = &quot;glm&quot;) %&gt;%  
  set_mode(&quot;classification&quot;)

# Bagged random forest (reqires baguette package)
bagged &lt;- bag_tree(min_n = 10) %&gt;%
  set_engine(&quot;rpart&quot;, times = 25) %&gt;%
  set_mode(&quot;classification&quot;)

# Define model rest metrics
custom_metrics &lt;- metric_set(accuracy, roc_auc, sensitivity, specificity)</code></pre>
<p>We of course have to split the dataset into a train and test set:</p>
<pre class="r"><code># Data split for training model
set.seed(512)
bike_split &lt;- initial_split(bike_crash, prop = 0.75, strata = crash_sevr) 
bike_train &lt;- bike_split %&gt;% training()
bike_test &lt;- bike_split %&gt;% testing()

# Cross validation for folds for higher prediction accuracy
set.seed(666)
bike_folds &lt;- vfold_cv(bike_train, v = 2, prop = 0.75,  strata = crash_sevr)

# Define model test metrics
bike_metrics &lt;- metric_set(accuracy, roc_auc, sensitivity, specificity)

# Specify the model formula (outcomes + predictors)
formula &lt;- formula(crash_sevr ~ .)</code></pre>
<p>Here are is an initial run of these models:</p>
<pre class="r"><code># Define recipe
bike_recipe &lt;- 
  recipe(formula, data = bike_train) %&gt;% 
  step_dummy(all_nominal(), -all_outcomes()) 

# Logistic regression workflow
bc_logreg_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe)  %&gt;% 
  add_model(logreg)

# Random forest workflow
bc_bagged_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe)  %&gt;% 
  add_model(bagged)

# We wan&#39;t to collect predictions
ctrl_preds &lt;- control_resamples(save_pred = TRUE)

# Let&#39;s fit!
bc_logreg_fit &lt;- fit_resamples(bc_logreg_wf, bike_folds, metrics = custom_metrics,  control = ctrl_preds) 
bc_bagged_fit &lt;- fit_resamples(bc_bagged_wf, bike_folds, metrics = custom_metrics, control = ctrl_preds)

# And evaluate
collect_metrics(bc_logreg_fit) %&gt;% 
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% add_header_lines(&quot;Logistic regression model&quot;)</code></pre>
<template id="a675c42b-11f8-440f-b381-ef5881e388b6"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-345b9a06{}.cl-3453dc44{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-34540bce{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-34540be2{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-34545b4c{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-34545b60{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-34545b6a{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-34545b6b{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-34545b74{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-34545b75{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-345b9a06'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-34545b74"><p class="cl-34540bce"><span class="cl-3453dc44">Logistic regression model</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-34545b74"><p class="cl-34540bce"><span class="cl-3453dc44">.metric</span></p></td><td class="cl-34545b74"><p class="cl-34540bce"><span class="cl-3453dc44">.estimator</span></p></td><td class="cl-34545b75"><p class="cl-34540be2"><span class="cl-3453dc44">mean</span></p></td><td class="cl-34545b75"><p class="cl-34540be2"><span class="cl-3453dc44">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">accuracy</span></p></td><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">binary</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.916</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.002</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">roc_auc</span></p></td><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">binary</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.699</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.002</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">sensitivity</span></p></td><td class="cl-34545b4c"><p class="cl-34540bce"><span class="cl-3453dc44">binary</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.008</span></p></td><td class="cl-34545b60"><p class="cl-34540be2"><span class="cl-3453dc44">0.002</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-34545b6a"><p class="cl-34540bce"><span class="cl-3453dc44">specificity</span></p></td><td class="cl-34545b6a"><p class="cl-34540bce"><span class="cl-3453dc44">binary</span></p></td><td class="cl-34545b6b"><p class="cl-34540be2"><span class="cl-3453dc44">0.998</span></p></td><td class="cl-34545b6b"><p class="cl-34540be2"><span class="cl-3453dc44">0.001</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="cc0e9f9f-90aa-402a-bc7b-c85954fb8ea1"></div>
<script>
var dest = document.getElementById("cc0e9f9f-90aa-402a-bc7b-c85954fb8ea1");
var template = document.getElementById("a675c42b-11f8-440f-b381-ef5881e388b6");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<pre class="r"><code>collect_metrics(bc_bagged_fit) %&gt;% 
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% add_header_lines(&quot;Bagged random forest model&quot;)</code></pre>
<template id="b656b162-c91b-4d1e-a39a-f11c63ba08cd"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-347711c8{}.cl-346f71d4{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-346f81ec{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-346f81f6{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-346fba7c{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-346fba86{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-346fba90{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-346fba9a{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-346fba9b{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-346fbaa4{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-347711c8'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-346fba9b"><p class="cl-346f81ec"><span class="cl-346f71d4">Bagged random forest model</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-346fba9b"><p class="cl-346f81ec"><span class="cl-346f71d4">.metric</span></p></td><td class="cl-346fba9b"><p class="cl-346f81ec"><span class="cl-346f71d4">.estimator</span></p></td><td class="cl-346fbaa4"><p class="cl-346f81f6"><span class="cl-346f71d4">mean</span></p></td><td class="cl-346fbaa4"><p class="cl-346f81f6"><span class="cl-346f71d4">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">accuracy</span></p></td><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">binary</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.922</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.003</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">roc_auc</span></p></td><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">binary</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.700</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.009</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">sensitivity</span></p></td><td class="cl-346fba7c"><p class="cl-346f81ec"><span class="cl-346f71d4">binary</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.014</span></p></td><td class="cl-346fba86"><p class="cl-346f81f6"><span class="cl-346f71d4">0.005</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-346fba90"><p class="cl-346f81ec"><span class="cl-346f71d4">specificity</span></p></td><td class="cl-346fba90"><p class="cl-346f81ec"><span class="cl-346f71d4">binary</span></p></td><td class="cl-346fba9a"><p class="cl-346f81f6"><span class="cl-346f71d4">0.998</span></p></td><td class="cl-346fba9a"><p class="cl-346f81f6"><span class="cl-346f71d4">0.000</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="02644af7-a728-46dc-a125-2f30be568a7e"></div>
<script>
var dest = document.getElementById("02644af7-a728-46dc-a125-2f30be568a7e");
var template = document.getElementById("b656b162-c91b-4d1e-a39a-f11c63ba08cd");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<p>In the initial modelling we get a very high accuracy for our models - indicating that it makes correct predictions more than 90 % of the time. This would be a great result if it weren’t for the class imbalance we noticed earlier. This means the dataset is biased towards predicting cases that belong to the major class, and thus doesn’t necissarily predict the minor class accurately. This is why we need to look at the sensitivity measure. Around 1 % of the time we get correct predictions of the minor class. That’s bad. Especially since that is the class we are most interested in predicting correctly.</p>
<p>We could adjust our model threshold in order to get a higher sensitivity (catch more severe cases), but that would harm our accuracy.</p>
<p>Because of this we will now try two different algorithms to <strong>resample the dataset</strong>; the rose algorithm; and the downsample-algorithm. These two represent to different ways of resampling. The rose algorithm utilises a k-nearest neighbour algorithm to generate more observations of the minor class in order to balance the outcome class. The downsample algorithm balances the observations by reducing the major class. Therefore they represent two opposite approaches to handling class imbalance.</p>
<pre class="r"><code># For one recipe set we apply the rose algorithm
set.seed(444)
bike_recipe_rose &lt;- 
bike_recipe %&gt;% 
  step_rose(crash_sevr) 

# And for the other we test the downsampling algorithm. 
set.seed(555)
bike_recipe_down &lt;- 
bike_recipe %&gt;% 
  step_downsample(crash_sevr) 

# ROSE
bc_logreg_rose_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe_rose)  %&gt;% 
  add_model(logreg)

bc_bagged_rose_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe_rose)  %&gt;% 
  add_model(bagged)

# DOWN
bc_logreg_down_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe_down)  %&gt;% 
  add_model(logreg)

bc_bagged_down_wf &lt;- workflow() %&gt;% 
  add_recipe(bike_recipe_down)  %&gt;% 
  add_model(bagged)

# Let&#39;s fit!
bc_logreg_rose_fit &lt;- fit_resamples(bc_logreg_rose_wf, bike_folds, metrics = custom_metrics, control = ctrl_preds)
bc_bagged_rose_fit &lt;- fit_resamples(bc_bagged_rose_wf, bike_folds, metrics = custom_metrics, control = ctrl_preds)

bc_logreg_down_fit &lt;- fit_resamples(bc_logreg_down_wf, bike_folds, metrics = custom_metrics, control = ctrl_preds)
bc_bagged_down_fit &lt;- fit_resamples(bc_bagged_down_wf, bike_folds, metrics = custom_metrics, control = ctrl_preds)


# And evaluate the rose algorithm 
collect_metrics(bc_logreg_rose_fit) %&gt;%
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% 
  add_header_lines(&quot;Logistic regression model (with rose-resampling)&quot;)</code></pre>
<template id="b96974dc-70ae-4244-b499-113d645d25ed"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-5b9f252e{}.cl-5b93583e{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5b9374ea{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5b9374fe{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5b93db24{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5b93db38{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5b93db39{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5b93db42{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5b93db4c{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5b93db56{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-5b9f252e'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-5b93db4c"><p class="cl-5b9374ea"><span class="cl-5b93583e">Logistic regression model (with rose-resampling)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5b93db4c"><p class="cl-5b9374ea"><span class="cl-5b93583e">.metric</span></p></td><td class="cl-5b93db4c"><p class="cl-5b9374ea"><span class="cl-5b93583e">.estimator</span></p></td><td class="cl-5b93db56"><p class="cl-5b9374fe"><span class="cl-5b93583e">mean</span></p></td><td class="cl-5b93db56"><p class="cl-5b9374fe"><span class="cl-5b93583e">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">accuracy</span></p></td><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">binary</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.695</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.002</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">roc_auc</span></p></td><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">binary</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.692</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.001</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">sensitivity</span></p></td><td class="cl-5b93db24"><p class="cl-5b9374ea"><span class="cl-5b93583e">binary</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.613</span></p></td><td class="cl-5b93db38"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.005</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5b93db39"><p class="cl-5b9374ea"><span class="cl-5b93583e">specificity</span></p></td><td class="cl-5b93db39"><p class="cl-5b9374ea"><span class="cl-5b93583e">binary</span></p></td><td class="cl-5b93db42"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.702</span></p></td><td class="cl-5b93db42"><p class="cl-5b9374fe"><span class="cl-5b93583e">0.003</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="bf7a14ff-8b48-481d-8f66-e6825d24749a"></div>
<script>
var dest = document.getElementById("bf7a14ff-8b48-481d-8f66-e6825d24749a");
var template = document.getElementById("b96974dc-70ae-4244-b499-113d645d25ed");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<pre class="r"><code>collect_metrics(bc_bagged_rose_fit) %&gt;% 
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% 
  add_header_lines(&quot;Bagged random forest model (with rose-resampling)&quot;)</code></pre>
<template id="2c45755e-e879-459e-806b-8f4a8aab2fb5"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-5bc8aff2{}.cl-5bbef340{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5bbf0574{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5bbf057e{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5bbfa4d4{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bbfa506{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bbfa510{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bbfa51a{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bbfa524{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bbfa525{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-5bc8aff2'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-5bbfa524"><p class="cl-5bbf0574"><span class="cl-5bbef340">Bagged random forest model (with rose-resampling)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bbfa524"><p class="cl-5bbf0574"><span class="cl-5bbef340">.metric</span></p></td><td class="cl-5bbfa524"><p class="cl-5bbf0574"><span class="cl-5bbef340">.estimator</span></p></td><td class="cl-5bbfa525"><p class="cl-5bbf057e"><span class="cl-5bbef340">mean</span></p></td><td class="cl-5bbfa525"><p class="cl-5bbf057e"><span class="cl-5bbef340">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">accuracy</span></p></td><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">binary</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.078</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.004</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">roc_auc</span></p></td><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">binary</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.499</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.000</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">sensitivity</span></p></td><td class="cl-5bbfa4d4"><p class="cl-5bbf0574"><span class="cl-5bbef340">binary</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">1.000</span></p></td><td class="cl-5bbfa506"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.000</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bbfa510"><p class="cl-5bbf0574"><span class="cl-5bbef340">specificity</span></p></td><td class="cl-5bbfa510"><p class="cl-5bbf0574"><span class="cl-5bbef340">binary</span></p></td><td class="cl-5bbfa51a"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.001</span></p></td><td class="cl-5bbfa51a"><p class="cl-5bbf057e"><span class="cl-5bbef340">0.001</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="64a8de64-71aa-40fe-a305-faeb00500e7c"></div>
<script>
var dest = document.getElementById("64a8de64-71aa-40fe-a305-faeb00500e7c");
var template = document.getElementById("2c45755e-e879-459e-806b-8f4a8aab2fb5");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<pre class="r"><code># And evaluate the downsample algorithm 
collect_metrics(bc_logreg_down_fit) %&gt;% 
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% 
add_header_lines(&quot;Logistic regression model (with downsampling)&quot;)</code></pre>
<template id="5c8da5e9-44b1-46be-b054-180c1863ce1e"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-5c042d34{}.cl-5bf8d880{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5bf8ff7c{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5bf8ff90{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5bf954fe{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bf95508{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bf95512{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bf95513{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bf9551c{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5bf9551d{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-5c042d34'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-5bf9551c"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">Logistic regression model (with downsampling)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bf9551c"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">.metric</span></p></td><td class="cl-5bf9551c"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">.estimator</span></p></td><td class="cl-5bf9551d"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">mean</span></p></td><td class="cl-5bf9551d"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">accuracy</span></p></td><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">binary</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.614</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.027</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">roc_auc</span></p></td><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">binary</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.670</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.003</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">sensitivity</span></p></td><td class="cl-5bf954fe"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">binary</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.654</span></p></td><td class="cl-5bf95508"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.013</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5bf95512"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">specificity</span></p></td><td class="cl-5bf95512"><p class="cl-5bf8ff7c"><span class="cl-5bf8d880">binary</span></p></td><td class="cl-5bf95513"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.611</span></p></td><td class="cl-5bf95513"><p class="cl-5bf8ff90"><span class="cl-5bf8d880">0.031</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="4b8e56e3-83b5-4b0c-bf67-e2511f43855a"></div>
<script>
var dest = document.getElementById("4b8e56e3-83b5-4b0c-bf67-e2511f43855a");
var template = document.getElementById("5c8da5e9-44b1-46be-b054-180c1863ce1e");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<pre class="r"><code>collect_metrics(bc_bagged_down_fit) %&gt;% 
  select(-.config, -n) %&gt;% 
  mutate(mean = round(mean, 3),
         std_err = round(std_err, 3)) %&gt;% 
  flextable() %&gt;% 
  add_header_lines(&quot;Bagged random forest model (with downsampling)&quot;)</code></pre>
<template id="3d4c188f-c99c-44c1-aa76-97b29b57ad2d"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-5c2670ce{}.cl-5c1d17b8{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5c1d2f5a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5c1d2f6e{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5c1d9008{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5c1d9012{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5c1d901c{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5c1d9026{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5c1d9027{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5c1d9030{width:54pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-5c2670ce'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="4"class="cl-5c1d9027"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">Bagged random forest model (with downsampling)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5c1d9027"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">.metric</span></p></td><td class="cl-5c1d9027"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">.estimator</span></p></td><td class="cl-5c1d9030"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">mean</span></p></td><td class="cl-5c1d9030"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">std_err</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">accuracy</span></p></td><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">binary</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.635</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.000</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">roc_auc</span></p></td><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">binary</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.701</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.001</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">sensitivity</span></p></td><td class="cl-5c1d9008"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">binary</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.665</span></p></td><td class="cl-5c1d9012"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.003</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5c1d901c"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">specificity</span></p></td><td class="cl-5c1d901c"><p class="cl-5c1d2f5a"><span class="cl-5c1d17b8">binary</span></p></td><td class="cl-5c1d9026"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.633</span></p></td><td class="cl-5c1d9026"><p class="cl-5c1d2f6e"><span class="cl-5c1d17b8">0.000</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="f0fb2e90-da5c-4f58-9b49-c1de43d3f33c"></div>
<script>
var dest = document.getElementById("f0fb2e90-da5c-4f58-9b49-c1de43d3f33c");
var template = document.getElementById("3d4c188f-c99c-44c1-aa76-97b29b57ad2d");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<p>We see that the rose algorithm has had a dramatic effect on the logistic regression model, but seems not to have had a great effect on the bagged RF model, which seems to not be working.</p>
<p>It also looks as if the downsampling algorithm has had a positive effect on both models. In both models get a lower accuracy and ROC-AUC (compared to no resampling) but again our sensitivity has increased by a lot, suggesting this model is better able to confine the relationship with our predictors and the outcome variable.</p>
<div id="model-selection" class="section level4">
<h4>Model selection</h4>
<p>But which model do we choose? Since both tables indicate very similar results, neither model is a clear winner.</p>
<p>Considering there is an element of randomness in both the initial train/test-splitting of the dataset and in applying the resampling algorithms, it is very possible that these minute differences could pushed in either direction if we were to set a different seed.</p>
<p>We want to select the model that is best able to predict true positives (ie. has the highest sensitivity) but also retains an ability to correctly predict true negatives (high specificity). The ROC-AUC is a measure that looks at both the specificity and sensitivity combined and is therefore useful for comparing models. In this case however I would argue that it would be misleading to select the model with the highest AUC. This is because of the class imbalance problem in our outcome variable. Without resampling the ROC-AUC is (somewhat) high for both the logistic regression model and the random forest model.</p>
<p>For our business problem it is however critical that our model is able to capture the effects leading to major injuries. I therefore suggest we go with the logistic regression model with the rose resampling.</p>
<pre class="r"><code># Looks like this one is the winner
collect_metrics(bc_logreg_rose_fit)</code></pre>
<pre><code>## # A tibble: 4 × 6
##   .metric     .estimator  mean     n std_err .config             
##   &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
## 1 accuracy    binary     0.695     2 0.00215 Preprocessor1_Model1
## 2 roc_auc     binary     0.692     2 0.00145 Preprocessor1_Model1
## 3 sensitivity binary     0.613     2 0.00502 Preprocessor1_Model1
## 4 specificity binary     0.702     2 0.00260 Preprocessor1_Model1</code></pre>
<pre class="r"><code># Confusion matrix
(tibble(
  pred = collect_predictions(bc_logreg_rose_fit)$.pred_class,
  truth = bike_train$crash_sevr) %&gt;% 
  conf_mat(truth = truth, estimate = pred) %&gt;% autoplot(type = &quot;heatmap&quot;) + 
    ggtitle(&quot;Confusion matrix for logistic  \n regression model with rose-resampling&quot;) +
    theme(panel.grid.major = element_blank() )) </code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code># EVALUATE MODEL ON TEST DATA
bike_last_fit &lt;- last_fit(bc_logreg_rose_wf, bike_split)

# Test_metrics
results &lt;- tibble(
  estimate = bike_last_fit$.predictions[[1]]$.pred_class,
  truth = bike_test$crash_sevr)

accuracy(results, truth, estimate)</code></pre>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.718</code></pre>
<pre class="r"><code>bind_rows(
collect_metrics(bike_last_fit),
sensitivity(results, truth, estimate),
specificity(results, truth, estimate))%&gt;%
  select(-.config, -.estimator) %&gt;% 
  mutate(.estimate = round(.estimate, 3)) %&gt;% 
  flextable() %&gt;%  width(width = 2.4) %&gt;% 
  add_header_lines(&quot;Logistic regression model (with rose-resampling) - kørt på test-data&quot;)</code></pre>
<template id="d99e7409-246a-4bec-bdcb-6b88d205832f"><style>
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
</style><div class="tabwid"><style>.cl-5f9fc214{}.cl-5f97e684{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5f97f750{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5f97f75a{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5f982a90{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f982a9a{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f982aa4{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f982aa5{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f982aae{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f982aaf{width:172.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-5f9fc214'>
<thead><tr style="overflow-wrap:break-word;"><td  colspan="2"class="cl-5f982aaf"><p class="cl-5f97f750"><span class="cl-5f97e684">Logistic regression model (with rose-resampling) - kørt på test-data</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f982aaf"><p class="cl-5f97f750"><span class="cl-5f97e684">.metric</span></p></td><td class="cl-5f982aae"><p class="cl-5f97f75a"><span class="cl-5f97e684">.estimate</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5f982a90"><p class="cl-5f97f750"><span class="cl-5f97e684">accuracy</span></p></td><td class="cl-5f982a9a"><p class="cl-5f97f75a"><span class="cl-5f97e684">0.718</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f982a90"><p class="cl-5f97f750"><span class="cl-5f97e684">roc_auc</span></p></td><td class="cl-5f982a9a"><p class="cl-5f97f75a"><span class="cl-5f97e684">0.752</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f982a90"><p class="cl-5f97f750"><span class="cl-5f97e684">sensitivity</span></p></td><td class="cl-5f982a9a"><p class="cl-5f97f75a"><span class="cl-5f97e684">0.691</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f982aa5"><p class="cl-5f97f750"><span class="cl-5f97e684">specificity</span></p></td><td class="cl-5f982aa4"><p class="cl-5f97f75a"><span class="cl-5f97e684">0.720</span></p></td></tr></tbody></table></div></template>
<div class="flextable-shadow-host" id="9f1b948c-1e74-48c5-adc1-ef157680500c"></div>
<script>
var dest = document.getElementById("9f1b948c-1e74-48c5-adc1-ef157680500c");
var template = document.getElementById("d99e7409-246a-4bec-bdcb-6b88d205832f");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
</script>

<pre class="r"><code># ROC-curve
roc_data &lt;- tibble(
pred  = bike_last_fit$.predictions[[1]] %&gt;% pull(`.pred_Major Injuries`), 
truth = bike_test$crash_sevr)

roc_curve(roc_data,
          truth = truth, 
          estimate = pred) %&gt;% 
  ggplot(aes(x = 1- specificity, y = sensitivity)) +
  geom_path() +
  coord_equal() +
  geom_abline(lty = 3)</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code># Clean up x_variable names
vars &lt;- bike_last_fit$.workflow[[1]]$fit$fit$preproc$x_var

vars &lt;- 
str_replace_all(vars, pattern = &quot;X|_|\\.|\\s+&quot;, &quot; &quot;) %&gt;% 
  str_replace_all(pattern = &quot;\\s+&quot;, &quot; &quot; ) %&gt;% 
  str_to_title()

# Visualise variables
(
bike_last_fit %&gt;% 
  pull(.workflow) %&gt;% 
  pluck(1) %&gt;% 
  tidy(exponentiate = TRUE) %&gt;% 
  filter(term != &quot;(Intercept)&quot;) %&gt;% 
    mutate(
      term = vars) %&gt;% 
  filter(p.value &lt; 0.05) %&gt;% 
  ggplot(aes(x = estimate, y = fct_reorder(term, estimate))) + 
  geom_point(aes(x = estimate)) +
  geom_errorbar(aes(
    xmin = estimate - std.error,
    xmax = estimate  + std.error )) +
  labs(x = &quot;Odds Ratio + Standard Error&quot;, y = &quot;Predictor Variable&quot;) 
) %&gt;% 
  ggplotly(tooltip = &quot;estimate&quot;, autosize = F, height = 750) %&gt;% 
  config(displayModeBar = F)</code></pre>
<div id="htmlwidget-3" style="width:480px;height:750px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"data":[{"x":[1.20138300527877,0.829565082166465,1.20477005736006,0.83832115580042,1.91411391374165,0.874529669445437,0.731882499392058,0.905859795463445,0.575335919168738,1.19162716313017,1.20544718337448,0.186584070338081,3.74814892655978,0.669539199530742,2.41894775621083,0.305195596498228,0.668118704482198,4.57726000064948,0.397821577624412,1.33330027964144,0.804458120939587,0.846730999200689,0.332612823212714,1.18358667932511,1.16655807670907,3.99210987579517,0.911893783530516,0.604973487288608,1.3279551346603,1.35806788096178,1.19566290884514,0.859782761411197,0.663919655839934,0.528768173362126,0.8844881972261,1.52641477623411,0.791062201537263,0.523418451332002,0.895416216509333],"y":[28,15,29,16,35,19,12,22,7,26,30,1,37,11,36,2,10,39,4,32,14,17,3,25,24,38,23,8,31,33,27,18,9,6,20,34,13,5,21],"text":["estimate: 1.2013830","estimate: 0.8295651","estimate: 1.2047701","estimate: 0.8383212","estimate: 1.9141139","estimate: 0.8745297","estimate: 0.7318825","estimate: 0.9058598","estimate: 0.5753359","estimate: 1.1916272","estimate: 1.2054472","estimate: 0.1865841","estimate: 3.7481489","estimate: 0.6695392","estimate: 2.4189478","estimate: 0.3051956","estimate: 0.6681187","estimate: 4.5772600","estimate: 0.3978216","estimate: 1.3333003","estimate: 0.8044581","estimate: 0.8467310","estimate: 0.3326128","estimate: 1.1835867","estimate: 1.1665581","estimate: 3.9921099","estimate: 0.9118938","estimate: 0.6049735","estimate: 1.3279551","estimate: 1.3580679","estimate: 1.1956629","estimate: 0.8597828","estimate: 0.6639197","estimate: 0.5287682","estimate: 0.8844882","estimate: 1.5264148","estimate: 0.7910622","estimate: 0.5234185","estimate: 0.8954162"],"type":"scatter","mode":"markers+lines","marker":{"autocolorscale":false,"color":"rgba(0,0,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,0,0,1)"}},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","opacity":1,"line":{"color":"transparent"},"error_x":{"array":[0.0490128603115776,0.030628541881533,0.0321802968978893,0.0427695019333593,0.101450014463856,0.0357821178252387,0.0433628187322119,0.0460691384369728,0.14652564499611,0.0822190366991034,0.0719038203636,0.334112985635702,0.657328362753423,0.198694706541413,0.358292784447601,0.323044888836039,0.153725377564811,0.570564110099973,0.319857713627183,0.0323101090841107,0.0415601937076527,0.0403879023376204,0.302730949670793,0.0319778920738454,0.0319392071193418,0.3539469439039,0.0284712934710093,0.188849752934514,0.039984519438877,0.0407599929123537,0.0308184040382526,0.031901252720551,0.0371665519303753,0.15852831864525,0.0302888012801453,0.128929355319802,0.0372400527068726,0.175605521555582,0.0278955066386349],"arrayminus":[0.0490128603115776,0.030628541881533,0.0321802968978893,0.0427695019333593,0.101450014463855,0.0357821178252387,0.0433628187322119,0.0460691384369728,0.14652564499611,0.0822190366991034,0.0719038203636,0.334112985635703,0.657328362753423,0.198694706541413,0.358292784447601,0.323044888836039,0.153725377564811,0.570564110099973,0.319857713627183,0.0323101090841107,0.0415601937076527,0.0403879023376204,0.302730949670793,0.0319778920738454,0.0319392071193418,0.3539469439039,0.0284712934710093,0.188849752934514,0.039984519438877,0.0407599929123537,0.0308184040382526,0.031901252720551,0.0371665519303753,0.15852831864525,0.0302888012801453,0.128929355319802,0.0372400527068726,0.175605521555582,0.0278955066386349],"type":"data","width":5.73979591836734,"symmetric":false,"color":"rgba(0,0,0,1)"},"frame":null}],"layout":{"margin":{"t":35.1282689912827,"r":39.8505603985056,"b":46.8576172685762,"l":312.660855126609},"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":15.2760481527605},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.412296566599975,5.4125917620518],"tickmode":"array","ticktext":["0","1","2","3","4","5"],"tickvals":[-5.55111512312578e-17,1,2,3,4,5],"categoryorder":"array","categoryarray":["0","1","2","3","4","5"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"y","title":{"text":"Odds Ratio + Standard Error","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.4,39.6],"tickmode":"array","ticktext":["Rd Feature Five Point Or More","Rd Feature Underpass","Light Cond Other","Rd Surface Other","Developmen Industrial","Workzone Yes","Rd Feature Bridge","Traff Cntrl Other","Speed Limit 50 55 Mph","Rd Feature Y Intersection","Rd Feature Shared Use Paths Or Trails","Rd Class Us Route","Developmen Farms Woods Pastures","Light Cond Dark Lighted Roadway","Rd Hill Yes","Rd Class Nc Route","Light Cond Dark Roadway Not Lighted","Speed Limit 40 45 Mph","Rd Class State Secondary Route","Crash Loc Non Intersection","Developmen Residential","Rd Conditio Dirty Wet","Traff Cntrl No Control Present","Rural Urban Urban","Locality Urban 70 Developed ","Rd Feature Driveway Private","Speed Limit 30 35 Mph","Rd Bent Straight","Rd Class Local Street","Rd Feature Driveway Public","Traff Cntrl Stop And Go Signal","Light Cond Daylight","Speed Limit 20 25 Mph","Crash Loc Non Roadway","Rd Class Public Vehicular Area","Rd Feature Traffic Circle Roundabout","Rd Feature Non Intersection Median Crossing","Traff Cntrl Flashing Stop And Go Signal","Rd Surface Gravel"],"tickvals":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39],"categoryorder":"array","categoryarray":["Rd Feature Five Point Or More","Rd Feature Underpass","Light Cond Other","Rd Surface Other","Developmen Industrial","Workzone Yes","Rd Feature Bridge","Traff Cntrl Other","Speed Limit 50 55 Mph","Rd Feature Y Intersection","Rd Feature Shared Use Paths Or Trails","Rd Class Us Route","Developmen Farms Woods Pastures","Light Cond Dark Lighted Roadway","Rd Hill Yes","Rd Class Nc Route","Light Cond Dark Roadway Not Lighted","Speed Limit 40 45 Mph","Rd Class State Secondary Route","Crash Loc Non Intersection","Developmen Residential","Rd Conditio Dirty Wet","Traff Cntrl No Control Present","Rural Urban Urban","Locality Urban 70 Developed ","Rd Feature Driveway Private","Speed Limit 30 35 Mph","Rd Bent Straight","Rd Class Local Street","Rd Feature Driveway Public","Traff Cntrl Stop And Go Signal","Light Cond Daylight","Speed Limit 20 25 Mph","Crash Loc Non Roadway","Rd Class Public Vehicular Area","Rd Feature Traffic Circle Roundabout","Rd Feature Non Intersection Median Crossing","Traff Cntrl Flashing Stop And Go Signal","Rd Surface Gravel"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.81901203819012,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"IBMPlexSans","size":11.9551681195517},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(204,204,204,1)","gridwidth":0.265670402656704,"zeroline":false,"anchor":"x","title":{"text":"Predictor Variable","font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":11.9551681195517}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"IBMPlexSans","size":12.2208385222084}},"hovermode":"closest","height":750,"barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"source":"A","attrs":{"8b95752069ac":{"x":{},"y":{},"type":"scatter"},"8b9522f9d747":{"x":{},"y":{},"xmin":{},"xmax":{}}},"cur_data":"8b95752069ac","visdat":{"8b95752069ac":["function (y) ","x"],"8b9522f9d747":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<pre class="r"><code># #last_fit_table &lt;-
# bike_last_fit %&gt;%
#   pull(.workflow) %&gt;%
#   pluck(1) %&gt;%
#   tidy(exponentiate = TRUE) %&gt;%
#   filter(term != &quot;(Intercept)&quot;,
#          p.value &lt; 0.05) %&gt;%
#   arrange(term) %&gt;%
#   mutate(p.value = round(p.value, 3),
#          statistic = round(statistic, 3),
#          std.error = round(std.error, 3),
#          estimate = round(estimate, 3)) %&gt;%
#   print(n = 100)</code></pre>
</div>
</div>
